<!DOCTYPE html>
<html lang="vi" class="js csstransforms3d">
  <head><script src="/PPV_Workshop_01/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=PPV_Workshop_01/livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.147.8">
    <meta name="description" content="">
<meta name="author" content="journeyoftheaverageguy@gmail.com">

    <link rel="icon" href="/PPV_Workshop_01/images/favicon.png" type="image/png">

    <title>Trò chuyện RAG với nhiều mô hình LLM :: AWS System Manager</title>

    
    <link href="/PPV_Workshop_01/css/nucleus.css?1753541793" rel="stylesheet">
    <link href="/PPV_Workshop_01/css/fontawesome-all.min.css?1753541793" rel="stylesheet">
    <link href="/PPV_Workshop_01/css/hybrid.css?1753541793" rel="stylesheet">
    <link href="/PPV_Workshop_01/css/featherlight.min.css?1753541793" rel="stylesheet">
    <link href="/PPV_Workshop_01/css/perfect-scrollbar.min.css?1753541793" rel="stylesheet">
    <link href="/PPV_Workshop_01/css/auto-complete.css?1753541793" rel="stylesheet">
    <link href="/PPV_Workshop_01/css/atom-one-dark-reasonable.css?1753541793" rel="stylesheet">
    <link href="/PPV_Workshop_01/css/theme.css?1753541793" rel="stylesheet">
    <link href="/PPV_Workshop_01/css/hugo-theme.css?1753541793" rel="stylesheet">
    
    <link href="/PPV_Workshop_01/css/theme-workshop.css?1753541793" rel="stylesheet">
    
    

    <script src="/PPV_Workshop_01/js/jquery-3.3.1.min.js?1753541793"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/PPV_Workshop_01/vi/7-rag/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="/">

<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff;}.cls-2{fill:#f90;fill-rule:evenodd;}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09,10.85a4.7,4.7,0,0,0,.19,1.48,7.73,7.73,0,0,0,.54,1.19.77.77,0,0,1,.12.38.64.64,0,0,1-.32.49l-1,.7a.83.83,0,0,1-.44.15.69.69,0,0,1-.49-.23,3.8,3.8,0,0,1-.6-.77q-.25-.42-.51-1a6.14,6.14,0,0,1-4.89,2.3,4.54,4.54,0,0,1-3.32-1.19,4.27,4.27,0,0,1-1.22-3.2A4.28,4.28,0,0,1,3.61,7.75,6.06,6.06,0,0,1,7.69,6.46a12.47,12.47,0,0,1,1.76.13q.92.13,1.91.36V5.73a3.65,3.65,0,0,0-.79-2.66A3.81,3.81,0,0,0,7.86,2.3a7.71,7.71,0,0,0-1.79.22,12.78,12.78,0,0,0-1.79.57,4.55,4.55,0,0,1-.58.22l-.26,0q-.35,0-.35-.52V2a1.09,1.09,0,0,1,.12-.58,1.2,1.2,0,0,1,.47-.35A10.88,10.88,0,0,1,5.77.32,10.19,10.19,0,0,1,8.36,0a6,6,0,0,1,4.35,1.35,5.49,5.49,0,0,1,1.38,4.09ZM7.34,13.38a5.36,5.36,0,0,0,1.72-.31A3.63,3.63,0,0,0,10.63,12,2.62,2.62,0,0,0,11.19,11a5.63,5.63,0,0,0,.16-1.44v-.7a14.35,14.35,0,0,0-1.53-.28,12.37,12.37,0,0,0-1.56-.1,3.84,3.84,0,0,0-2.47.67A2.34,2.34,0,0,0,5,11a2.35,2.35,0,0,0,.61,1.76A2.4,2.4,0,0,0,7.34,13.38Zm13.35,1.8a1,1,0,0,1-.64-.16,1.3,1.3,0,0,1-.35-.65L15.81,1.51a3,3,0,0,1-.15-.67.36.36,0,0,1,.41-.41H17.7a1,1,0,0,1,.65.16,1.4,1.4,0,0,1,.33.65l2.79,11,2.59-11A1.17,1.17,0,0,1,24.39.6a1.1,1.1,0,0,1,.67-.16H26.4a1.1,1.1,0,0,1,.67.16,1.17,1.17,0,0,1,.32.65L30,12.39,32.88,1.25A1.39,1.39,0,0,1,33.22.6a1,1,0,0,1,.65-.16h1.54a.36.36,0,0,1,.41.41,1.36,1.36,0,0,1,0,.26,3.64,3.64,0,0,1-.12.41l-4,12.86a1.3,1.3,0,0,1-.35.65,1,1,0,0,1-.64.16H29.25a1,1,0,0,1-.67-.17,1.26,1.26,0,0,1-.32-.67L25.67,3.64,23.11,14.34a1.26,1.26,0,0,1-.32.67,1,1,0,0,1-.67.17Zm21.36.44a11.28,11.28,0,0,1-2.56-.29,7.44,7.44,0,0,1-1.92-.67,1,1,0,0,1-.61-.93v-.84q0-.52.38-.52a.9.9,0,0,1,.31.06l.42.17a8.77,8.77,0,0,0,1.83.58,9.78,9.78,0,0,0,2,.2,4.48,4.48,0,0,0,2.43-.55,1.76,1.76,0,0,0,.86-1.57,1.61,1.61,0,0,0-.45-1.16A4.29,4.29,0,0,0,43,9.22l-2.41-.76A5.15,5.15,0,0,1,38,6.78a3.94,3.94,0,0,1-.83-2.41,3.7,3.7,0,0,1,.45-1.85,4.47,4.47,0,0,1,1.19-1.37A5.27,5.27,0,0,1,40.51.29,7.4,7.4,0,0,1,42.6,0a8.87,8.87,0,0,1,1.12.07q.57.07,1.08.19t.95.26a4.27,4.27,0,0,1,.7.29,1.59,1.59,0,0,1,.49.41.94.94,0,0,1,.15.55v.79q0,.52-.38.52a1.76,1.76,0,0,1-.64-.2,7.74,7.74,0,0,0-3.2-.64,4.37,4.37,0,0,0-2.21.47,1.6,1.6,0,0,0-.79,1.48,1.58,1.58,0,0,0,.49,1.18,4.94,4.94,0,0,0,1.83.92L44.55,7a5.08,5.08,0,0,1,2.57,1.6A3.76,3.76,0,0,1,47.9,11a4.21,4.21,0,0,1-.44,1.93,4.4,4.4,0,0,1-1.21,1.47,5.43,5.43,0,0,1-1.85.93A8.25,8.25,0,0,1,42.05,15.62Z"></path><path class="cls-2" d="M45.19,23.81C39.72,27.85,31.78,30,25,30A36.64,36.64,0,0,1,.22,20.57c-.51-.46-.06-1.09.56-.74A49.78,49.78,0,0,0,25.53,26.4,49.23,49.23,0,0,0,44.4,22.53C45.32,22.14,46.1,23.14,45.19,23.81Z"></path><path class="cls-2" d="M47.47,21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74,3.13-2.2,8.27-1.57,8.86-.83s-.16,5.89-3.09,8.35c-.45.38-.88.18-.68-.32C46.69,25.8,48.17,22.11,47.47,21.21Z"></path></svg>

</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/PPV_Workshop_01/js/lunr.min.js?1753541793"></script>
<script type="text/javascript" src="/PPV_Workshop_01/js/auto-complete.js?1753541793"></script>
<script type="text/javascript">
    
        var baseurl = "http:\/\/localhost:1313\/PPV_Workshop_01\/\/vi";
    
</script>
<script type="text/javascript" src="/PPV_Workshop_01/js/search.js?1753541793"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/PPV_Workshop_01/vi/1-introduce/" title="Giới thiệu" class="dd-item 
        
        
        
        ">
      <a href="/PPV_Workshop_01/vi/1-introduce/">
           <b> 1. </b> Giới thiệu
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/PPV_Workshop_01/vi/2-prerequiste/" title="Chuẩn bị " class="dd-item 
        
        
        
        ">
      <a href="/PPV_Workshop_01/vi/2-prerequiste/">
           <b> 2. </b> Chuẩn bị 
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/PPV_Workshop_01/vi/2-prerequiste/2.1-launchastack/" title="Khởi chạy CloudFormation stack" class="dd-item 
        
        
        
        ">
      <a href="/PPV_Workshop_01/vi/2-prerequiste/2.1-launchastack/">
           <b> 2.1 </b> Khởi chạy CloudFormation stack
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/PPV_Workshop_01/vi/2-prerequiste/2.2-launchvscode/" title="Khởi chạy VSCode trên AWS và Thiết lập Môi trường" class="dd-item 
        
        
        
        ">
      <a href="/PPV_Workshop_01/vi/2-prerequiste/2.2-launchvscode/">
           <b> 2.2 </b> Khởi chạy VSCode trên AWS và Thiết lập Môi trường
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/PPV_Workshop_01/vi/3-accessibilitytoinstances/" title="Triển khai Ứng dụng Serverless Amazon Bedrock" class="dd-item 
        
        
        
        ">
      <a href="/PPV_Workshop_01/vi/3-accessibilitytoinstances/">
           <b> 3. </b> Triển khai Ứng dụng Serverless Amazon Bedrock
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/PPV_Workshop_01/vi/4-walkthroughbedrock/" title="Hướng dẫn sử dụng Amazon Bedrock Console" class="dd-item 
        
        
        
        ">
      <a href="/PPV_Workshop_01/vi/4-walkthroughbedrock/">
           <b> 4. </b> Hướng dẫn sử dụng Amazon Bedrock Console
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/PPV_Workshop_01/vi/5-multiplellms/" title="Trò chuyện tổng quát với nhiều mô hình LLM" class="dd-item 
        
        
        
        ">
      <a href="/PPV_Workshop_01/vi/5-multiplellms/">
           <b> 5. </b> Trò chuyện tổng quát với nhiều mô hình LLM
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/PPV_Workshop_01/vi/6-usingamazonkendra/" title="Lập chỉ mục dữ liệu nguồn bằng Amazon Kendra" class="dd-item 
        
        
        
        ">
      <a href="/PPV_Workshop_01/vi/6-usingamazonkendra/">
           <b> 6. </b> Lập chỉ mục dữ liệu nguồn bằng Amazon Kendra
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/PPV_Workshop_01/vi/7-rag/" title="Trò chuyện RAG với nhiều mô hình LLM" class="dd-item 
        
        active
        
        ">
      <a href="/PPV_Workshop_01/vi/7-rag/">
           <b> 7. </b> Trò chuyện RAG với nhiều mô hình LLM
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/PPV_Workshop_01/vi/8-promptengineering/" title="Kỹ thuật thiết kế Prompt" class="dd-item 
        
        
        
        ">
      <a href="/PPV_Workshop_01/vi/8-promptengineering/">
           <b> 8. </b> Kỹ thuật thiết kế Prompt
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/PPV_Workshop_01/vi/9-knowledgebases/" title="Trò chuyện RAG với Bedrock Knowledge Bases" class="dd-item 
        
        
        
        ">
      <a href="/PPV_Workshop_01/vi/9-knowledgebases/">
           <b> 9. </b> Trò chuyện RAG với Bedrock Knowledge Bases
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/PPV_Workshop_01/vi/9-knowledgebases/9.1-createknowledgebase/" title="Tạo và Kiểm thử Knowledge Base" class="dd-item 
        
        
        
        ">
      <a href="/PPV_Workshop_01/vi/9-knowledgebases/9.1-createknowledgebase/">
           <b> 9.1 </b> Tạo và Kiểm thử Knowledge Base
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/PPV_Workshop_01/vi/9-knowledgebases/9.2-integrateknowledgebase/" title="Tích hợp Knowledge Base với Lambda Function" class="dd-item 
        
        
        
        ">
      <a href="/PPV_Workshop_01/vi/9-knowledgebases/9.2-integrateknowledgebase/">
           <b> 9.2 </b> Tích hợp Knowledge Base với Lambda Function
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/PPV_Workshop_01/vi/10-cleanup/" title="Dọn dẹp tài nguyên" class="dd-item 
        
        
        
        ">
      <a href="/PPV_Workshop_01/vi/10-cleanup/">
           <b> 10. </b> Dọn dẹp tài nguyên
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://www.facebook.com/groups/awsstudygroupfcj/"><i class='fab fa-facebook'></i> AWS Study Group</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="http://localhost:1313/PPV_Workshop_01/7-rag/">English</option>
                    
                  
              
                  
              
          
              
              
                  
              
                  
                    
                    
                      <option id="vi" value="http://localhost:1313/PPV_Workshop_01/vi/7-rag/" selected>Tiếng Việt</option>
                    
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <left>
    
     <b> Workshop</b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7920860&style=0038&nbdigits=9&type=page&initCount=0" title="Migrate" Alt="web counter"   border="0" /></a>  <br>
     <b> <a href="https://cloudjourney.awsstudygroup.com/">Cloud Journey</a></b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7830807&style=0038&nbdigits=9&type=page&initCount=0" title="Total CLoud Journey" Alt="web counter"   border="0"   />
     
</left>
<left>
    <br>
    <br>
        <b> Last Updated </b> <br>
        <i><font color=orange>26-07-2025</font></i>
    </left>
    <left>
        <br>
        <br>
            <b> Team </b> <br>
           
            <i> <a href="https://www.facebook.com/pham.phu.vinh.220432/?locale=vi_VN"  style="color:orange">Phạm Phú Vinh  </a> <br>

               
        </i>
        </left>

<script async defer src="https://buttons.github.io/buttons.js"></script>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            <a href='/PPV_Workshop_01/vi/'>Tạo Chatbot Serverless Sử Dụng Amazon Bedrock, Amazon Kendra và Dữ Liệu Của Riêng Bạn</a> > Trò chuyện RAG với nhiều mô hình LLM
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#giải-pháp-dựa-trên-rag-với-amazon-bedrock-và-langchain">Giải pháp dựa trên RAG với Amazon Bedrock và LangChain</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Trò chuyện RAG với nhiều mô hình LLM
            </h1>
          

        



	<p>Bạn đã triển khai thành công ứng dụng chatbot serverless sử dụng Amazon Bedrock và đã cấp quyền truy cập cho các Mô hình Ngôn ngữ Lớn (LLMs) cần thiết thông qua bảng điều khiển Amazon Bedrock. Ngoài ra, bạn cũng đã hoàn tất thiết lập Amazon Kendra.</p>
<h2 id="giải-pháp-dựa-trên-rag-với-amazon-bedrock-và-langchain">Giải pháp dựa trên RAG với Amazon Bedrock và LangChain</h2>
<p>Giải pháp trong workshop này được xây dựng dựa trên phương pháp Retrieval-Augmented Generation (RAG). RAG là một kiến trúc mô hình kết hợp giữa kỹ thuật truy xuất và sinh văn bản nhằm nâng cao chất lượng và mức độ phù hợp của nội dung được tạo ra. Khi bạn nhập một câu hỏi vào ô văn bản, các bước xử lý sau sẽ được thực hiện phía backend để cung cấp cho bạn câu trả lời dựa trên tài liệu nguồn:</p>
<p><strong>Retrieval (Truy xuất)</strong>: Quá trình này tìm kiếm trong một tập hợp văn bản lớn để xác định thông tin hoặc ngữ cảnh phù hợp. Trong bước này, Amazon Kendra nhận câu hỏi từ yêu cầu và tìm kiếm các câu trả lời cũng như tài liệu tham khảo liên quan.</p>
<p><strong>Augmentation (Tăng cường)</strong>: Sau khi truy xuất được thông tin phù hợp, mô hình sử dụng ngữ cảnh đó để tăng cường khả năng sinh văn bản. Điều này giúp nội dung tạo ra có tính liên quan về ngữ cảnh và giàu thông tin.</p>
<p><strong>Generation (Sinh nội dung)</strong>: Trong RAG, đây là quá trình mô hình tạo ra văn bản mới dựa trên ngữ cảnh đã truy xuất và tăng cường. Văn bản được sinh ra có thể là câu trả lời, phản hồi hoặc giải thích.</p>
<p><strong>LangChain</strong>: Để điều phối toàn bộ quy trình này, workshop sử dụng tác nhân LangChain. Các lớp trừu tượng linh hoạt và bộ công cụ toàn diện của LangChain giúp nhà phát triển tận dụng tối đa sức mạnh của các mô hình nền tảng (Foundation Models - FMs).</p>
<p>Trong tác vụ này, bạn sẽ triển khai một hàm Lambda RAG (Retrieve, Analyze, Generate) để cung cấp trải nghiệm chatbot theo ngữ cảnh với tập dữ liệu của bạn. Các tập dữ liệu mẫu được lưu trữ trên Amazon S3 và được lập chỉ mục bằng Amazon Kendra. Để điều phối luồng giữa truy vấn người dùng, chỉ mục Kendra và các mô hình LLMs, bạn sẽ sử dụng LangChain làm công cụ điều phối. Mã Lambda được cung cấp sử dụng API của LangChain để trừu tượng hóa logic tích hợp phức tạp này.</p>
<p>Bằng cách tận dụng sức mạnh của Amazon Bedrock, Amazon Kendra và LangChain, bạn có thể xây dựng một trải nghiệm chatbot liền mạch và theo ngữ cảnh cho người dùng, giúp họ tương tác với tập dữ liệu một cách tự nhiên và hiệu quả.</p>
<p>Trong phần này, bạn sẽ cập nhật và triển khai một hàm Lambda RAG. Hàm này cho phép trò chuyện theo ngữ cảnh với nhiều mô hình ngôn ngữ lớn khác nhau.</p>
<ol>
<li>
<p>Mở trình soạn thảo <strong>VSCode</strong>.</p>
</li>
<li>
<p>Từ dự án <strong>bedrock-serverless-workshop</strong>, mở hàm <strong>/lambdas/ragFunctions/ragfunction.py</strong>, sao chép đoạn mã bên dưới và cập nhật mã trong hàm. Hàm này chứa logic hỗ trợ các mô hình Claude 3 (Haiku, Sonnet, v.v.), Mistral và Llama.</p>
</li>
</ol>
<p><img src="https://github.com/PVinhP/PPV_Workshop_01/blob/main/Workshop/static/images/5.fwd/task5/007.png?raw=true" alt="ConnectPrivate"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>import os
</span></span><span style="display:flex;"><span>import json
</span></span><span style="display:flex;"><span>import boto3
</span></span><span style="display:flex;"><span>from langchain_community.retrievers import AmazonKendraRetriever
</span></span><span style="display:flex;"><span>from langchain_aws import ChatBedrock
</span></span><span style="display:flex;"><span>from langchain.chains import ConversationalRetrievalChain
</span></span><span style="display:flex;"><span>from langchain.memory import ConversationBufferMemory
</span></span><span style="display:flex;"><span>from langchain.prompts import PromptTemplate
</span></span><span style="display:flex;"><span>from langchain.chains import RetrievalQA
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>import traceback
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kendra <span style="color:#f92672">=</span> boto3.client<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;kendra&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>chain_type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;stuff&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>KENDRA_INDEX_ID <span style="color:#f92672">=</span> os.getenv<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;KENDRA_INDEX_ID&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>S3_BUCKET_NAME <span style="color:#f92672">=</span> os.environ<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;S3_BUCKET_NAME&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>refine_prompt_template <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Below is an instruction that describes a task. &#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Write a response that appropriately completes the request.\n\n&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;### Instruction:\n&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;This is the original question: {question}\n&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;The existing answer: {existing_answer}\n&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Now there are some additional texts, (if needed) you can use them to improve your existing answer.&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;\n\n&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;{context_str}\n&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;\\nn&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Please use the new passage to further improve your answer.\n\n&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;### Response: &#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>initial_qa_template <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Below is an instruction that describes a task. &#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Write a response that appropriately completes the request.\n\n&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;### Instruction:\n&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;The following is background knowledge：\n&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;{context_str}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;\n&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Please answer this question based on the background knowledge provided above：{question}。\n\n&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;### Response: &#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def lambda_handler<span style="color:#f92672">(</span>event, context<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>    print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#34;Event is: {event}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    event_body <span style="color:#f92672">=</span> json.loads<span style="color:#f92672">(</span>event<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;body&#34;</span><span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span>    question <span style="color:#f92672">=</span> event_body<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;query&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#34;Query is: {question}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    model_id <span style="color:#f92672">=</span> event_body<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;model_id&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    temperature <span style="color:#f92672">=</span> event_body<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;temperature&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    max_tokens <span style="color:#f92672">=</span> event_body<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;max_tokens&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    status_code <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    PROMPT_TEMPLATE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;prompt-engineering/claude-prompt-template.txt&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    try:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> model_id <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;mistral.mistral-7b-instruct-v0:2&#39;</span>:
</span></span><span style="display:flex;"><span>            llm <span style="color:#f92672">=</span> get_mistral_llm<span style="color:#f92672">(</span>model_id,temperature,max_tokens<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            PROMPT_TEMPLATE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;prompt-engineering/mistral-prompt-template.txt&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> model_id <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;meta.llama3-1-8b-instruct-v1:0&#39;</span>:
</span></span><span style="display:flex;"><span>            llm <span style="color:#f92672">=</span> get_llama_llm<span style="color:#f92672">(</span>model_id,temperature,max_tokens<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            PROMPT_TEMPLATE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;prompt-engineering/llama-prompt-template.txt&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            llm <span style="color:#f92672">=</span> get_claude_llm<span style="color:#f92672">(</span>model_id,temperature,max_tokens<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            PROMPT_TEMPLATE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;prompt-engineering/claude-prompt-template.txt&#39;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Read the prompt template from S3 bucket</span>
</span></span><span style="display:flex;"><span>        s3 <span style="color:#f92672">=</span> boto3.resource<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;s3&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        obj <span style="color:#f92672">=</span> s3.Object<span style="color:#f92672">(</span>S3_BUCKET_NAME, PROMPT_TEMPLATE<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>        prompt_template <span style="color:#f92672">=</span> obj.get<span style="color:#f92672">()[</span><span style="color:#e6db74">&#39;Body&#39;</span><span style="color:#f92672">]</span>.read<span style="color:#f92672">()</span>.decode<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;utf-8&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#34;prompt template: {prompt_template}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        retriever <span style="color:#f92672">=</span> AmazonKendraRetriever<span style="color:#f92672">(</span>kendra_client<span style="color:#f92672">=</span>kendra,index_id<span style="color:#f92672">=</span>KENDRA_INDEX_ID<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> chain_type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;stuff&#34;</span>:
</span></span><span style="display:flex;"><span>            PROMPT <span style="color:#f92672">=</span> PromptTemplate<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                template<span style="color:#f92672">=</span>prompt_template, input_variables<span style="color:#f92672">=[</span><span style="color:#e6db74">&#34;context&#34;</span>, <span style="color:#e6db74">&#34;question&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            chain_type_kwargs <span style="color:#f92672">=</span> <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;prompt&#34;</span>: PROMPT<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            qa <span style="color:#f92672">=</span> RetrievalQA.from_chain_type<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                llm<span style="color:#f92672">=</span>llm,
</span></span><span style="display:flex;"><span>                chain_type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;stuff&#34;</span>,
</span></span><span style="display:flex;"><span>                retriever<span style="color:#f92672">=</span>retriever,
</span></span><span style="display:flex;"><span>                return_source_documents<span style="color:#f92672">=</span>True,
</span></span><span style="display:flex;"><span>                chain_type_kwargs<span style="color:#f92672">=</span>chain_type_kwargs<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            response <span style="color:#f92672">=</span> qa<span style="color:#f92672">(</span>question, return_only_outputs<span style="color:#f92672">=</span>False<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> chain_type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;refine&#34;</span>:
</span></span><span style="display:flex;"><span>            refine_prompt <span style="color:#f92672">=</span> PromptTemplate<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                input_variables<span style="color:#f92672">=[</span><span style="color:#e6db74">&#34;question&#34;</span>, <span style="color:#e6db74">&#34;existing_answer&#34;</span>, <span style="color:#e6db74">&#34;context_str&#34;</span><span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>                template<span style="color:#f92672">=</span>refine_prompt_template,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            initial_qa_prompt <span style="color:#f92672">=</span> PromptTemplate<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                input_variables<span style="color:#f92672">=[</span><span style="color:#e6db74">&#34;context_str&#34;</span>, <span style="color:#e6db74">&#34;question&#34;</span><span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>                template<span style="color:#f92672">=</span>prompt_template,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            chain_type_kwargs <span style="color:#f92672">=</span> <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;question_prompt&#34;</span>: initial_qa_prompt, <span style="color:#e6db74">&#34;refine_prompt&#34;</span>: refine_prompt<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            qa <span style="color:#f92672">=</span> RetrievalQA.from_chain_type<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                llm<span style="color:#f92672">=</span>llm, 
</span></span><span style="display:flex;"><span>                chain_type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;refine&#34;</span>,
</span></span><span style="display:flex;"><span>                retriever<span style="color:#f92672">=</span>retriever,
</span></span><span style="display:flex;"><span>                return_source_documents<span style="color:#f92672">=</span>True,
</span></span><span style="display:flex;"><span>                chain_type_kwargs<span style="color:#f92672">=</span>chain_type_kwargs<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            response <span style="color:#f92672">=</span> qa<span style="color:#f92672">(</span>question, return_only_outputs<span style="color:#f92672">=</span>False<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Response&#39;</span>, response<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        source_documents <span style="color:#f92672">=</span> response.get<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;source_documents&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        source_docs <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span>
</span></span><span style="display:flex;"><span>        previous_source <span style="color:#f92672">=</span> None
</span></span><span style="display:flex;"><span>        previous_score <span style="color:#f92672">=</span> None
</span></span><span style="display:flex;"><span>        response_data <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#if chain_type == &#34;stuff&#34;:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> source_doc in source_documents:
</span></span><span style="display:flex;"><span>            source <span style="color:#f92672">=</span> source_doc.metadata<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;source&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>            score <span style="color:#f92672">=</span> source_doc.metadata<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;score&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> source !<span style="color:#f92672">=</span> previous_source or score !<span style="color:#f92672">=</span> previous_score:
</span></span><span style="display:flex;"><span>                source_data <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;source&#34;</span>: source,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;score&#34;</span>: score
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                response_data.append<span style="color:#f92672">(</span>source_data<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                previous_source <span style="color:#f92672">=</span> source
</span></span><span style="display:flex;"><span>                previous_score <span style="color:#f92672">=</span> score
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        response_with_metadata <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;answer&#34;</span>: response.get<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;result&#39;</span><span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;source_documents&#34;</span>: response_data
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;statusCode&#39;</span>: status_code,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;headers&#39;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;Access-Control-Allow-Origin&#39;</span>: <span style="color:#e6db74">&#39;*&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;Access-Control-Allow-Headers&#39;</span>: <span style="color:#e6db74">&#39;Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;Access-Control-Allow-Methods&#39;</span>: <span style="color:#e6db74">&#39;OPTIONS,POST&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;body&#39;</span>: json.dumps<span style="color:#f92672">(</span>response_with_metadata<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    except Exception as e:
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#34;An unexpected error occurred: {str(e)}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        stack_trace <span style="color:#f92672">=</span> traceback.format_exc<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#34;stack trace: {stack_trace}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#34;error: {str(e)}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> str<span style="color:#f92672">(</span>e<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;statusCode&#39;</span>: status_code,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;headers&#39;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;Access-Control-Allow-Origin&#39;</span>: <span style="color:#e6db74">&#39;*&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;Access-Control-Allow-Headers&#39;</span>: <span style="color:#e6db74">&#39;Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;Access-Control-Allow-Methods&#39;</span>: <span style="color:#e6db74">&#39;OPTIONS,POST&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;body&#39;</span>: json.dumps<span style="color:#f92672">({</span><span style="color:#e6db74">&#39;error&#39;</span>: response<span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>def get_claude_llm<span style="color:#f92672">(</span>model_id, temperature, max_tokens<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>    model_kwargs <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;max_tokens&#34;</span>: max_tokens,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;temperature&#34;</span>: temperature, 
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;top_k&#34;</span>: 50, 
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;top_p&#34;</span>: 0.95
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    llm <span style="color:#f92672">=</span> ChatBedrock<span style="color:#f92672">(</span>model_id<span style="color:#f92672">=</span>model_id, model_kwargs<span style="color:#f92672">=</span>model_kwargs<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> llm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def get_llama_llm<span style="color:#f92672">(</span>model_id, temperature, max_tokens<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>    model_kwargs <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;max_gen_len&#34;</span>: max_tokens,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;temperature&#34;</span>: temperature, 
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;top_p&#34;</span>: 0.9
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    llm <span style="color:#f92672">=</span> ChatBedrock<span style="color:#f92672">(</span>model_id<span style="color:#f92672">=</span>model_id, model_kwargs<span style="color:#f92672">=</span>model_kwargs<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> llm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def get_mistral_llm<span style="color:#f92672">(</span>model_id, temperature, max_tokens<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>    model_kwargs <span style="color:#f92672">=</span> <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;max_tokens&#34;</span>: max_tokens,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;temperature&#34;</span>: temperature, 
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;top_k&#34;</span>: 50, 
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;top_p&#34;</span>: 0.9
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    llm <span style="color:#f92672">=</span> ChatBedrock<span style="color:#f92672">(</span>model_id<span style="color:#f92672">=</span>model_id, model_kwargs<span style="color:#f92672">=</span>model_kwargs<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> llm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def get_memory<span style="color:#f92672">()</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    memory <span style="color:#f92672">=</span> ConversationBufferMemory<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>        memory_key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;chat_history&#34;</span>,
</span></span><span style="display:flex;"><span>        input_key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;question&#34;</span>,
</span></span><span style="display:flex;"><span>        output_key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;answer&#34;</span>,
</span></span><span style="display:flex;"><span>        return_messages<span style="color:#f92672">=</span>True
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> memory
</span></span></code></pre></div><ol start="3">
<li>Từ terminal của <strong>VSCode</strong>, chạy lệnh sau để build và triển khai với mã Lambda đã được cập nhật:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd ~/environment/bedrock-serverless-workshop
</span></span><span style="display:flex;"><span>sam build <span style="color:#f92672">&amp;&amp;</span> sam deploy
</span></span></code></pre></div><p>Trong tác vụ này, bạn sẽ có cơ hội làm việc với các mô hình LLM sau, mỗi mô hình đều mang đến các tính năng và thế mạnh riêng biệt:</p>
<ul>
<li><strong>anthropic.claude-3-haiku - Claude 3 Haiku</strong> là mô hình nhanh nhất và nhỏ gọn nhất của Anthropic, mang lại khả năng phản hồi gần như tức thì. Haiku là lựa chọn tối ưu để xây dựng trải nghiệm AI liền mạch, mô phỏng tương tác tự nhiên như con người.</li>
<li><strong>anthropic.claude-3-5-sonnet - Claude 3.5 Sonnet</strong> là mô hình tiên tiến và thông minh nhất của Anthropic, thể hiện năng lực vượt trội trong nhiều tác vụ và bài đánh giá khác nhau.</li>
<li><strong>anthropic.claude-3-opus - Claude 3 Opus</strong> là một mô hình cực kỳ thông minh với hiệu năng ổn định trên các tác vụ phức tạp. Opus có thể xử lý các yêu cầu mở, chưa từng thấy trước đó với độ trôi chảy cao và khả năng hiểu giống con người. Hãy sử dụng Opus để tự động hóa công việc, tăng tốc nghiên cứu và phát triển trong nhiều lĩnh vực và ngành nghề khác nhau.</li>
<li><strong>mistral.mistral-7b-instruct - Mistral</strong> là một mô hình ngôn ngữ lớn hiệu quả cao, được tối ưu hóa cho các tác vụ ngôn ngữ yêu cầu dung lượng lớn và độ trễ thấp. Các trường hợp sử dụng phổ biến của Mistral bao gồm: tóm tắt văn bản, cấu trúc lại thông tin, trả lời câu hỏi và hoàn thành mã nguồn.</li>
<li><strong>meta.llama3-1-8b-instruct - Llama 3.1 8B</strong> phù hợp nhất với các hệ thống có tài nguyên tính toán giới hạn. Mô hình này đặc biệt mạnh trong các tác vụ như tóm tắt văn bản, phân loại văn bản, phân tích cảm xúc và dịch ngôn ngữ với yêu cầu suy luận có độ trễ thấp.</li>
</ul>
<ol start="4">
<li>Quay lại trình duyệt và mở trang web chatbot. Nhấp vào liên kết <strong>RAG Chat with LLMs</strong>. Giao diện trang web sẽ hiển thị như sau:</li>
</ol>
<p><img src="https://github.com/PVinhP/PPV_Workshop_01/blob/main/Workshop/static/images/5.fwd/task5/008.png?raw=true" alt="ConnectPrivate"></p>
<ol start="5">
<li>Đặt bất kỳ câu hỏi nào bằng cách nhập vào ô Query và nhấn nút <strong>Ask Question</strong>. Bạn có thể thử một câu hỏi mẫu ở bảng bên phải. Dưới đây là một ví dụ về câu hỏi và phản hồi từ Claude 3 Haiku. Bạn cũng có thể thử với các mô hình LLM khác và so sánh kết quả.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>What is federal funds rate as of September 2024?
</span></span></code></pre></div><p><img src="https://github.com/PVinhP/PPV_Workshop_01/blob/main/Workshop/static/images/5.fwd/task5/009.png?raw=true" alt="ConnectPrivate"></p>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/PPV_Workshop_01/vi/6-usingamazonkendra/" title="Lập chỉ mục dữ liệu nguồn bằng Amazon Kendra"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/PPV_Workshop_01/vi/8-promptengineering/" title="Kỹ thuật thiết kế Prompt" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/PPV_Workshop_01/js/clipboard.min.js?1753541793"></script>
    <script src="/PPV_Workshop_01/js/perfect-scrollbar.min.js?1753541793"></script>
    <script src="/PPV_Workshop_01/js/perfect-scrollbar.jquery.min.js?1753541793"></script>
    <script src="/PPV_Workshop_01/js/jquery.sticky.js?1753541793"></script>
    <script src="/PPV_Workshop_01/js/featherlight.min.js?1753541793"></script>
    <script src="/PPV_Workshop_01/js/highlight.pack.js?1753541793"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/PPV_Workshop_01/js/modernizr.custom-3.6.0.js?1753541793"></script>
    <script src="/PPV_Workshop_01/js/learn.js?1753541793"></script>
    <script src="/PPV_Workshop_01/js/hugo-learn.js?1753541793"></script>

    <link href="/PPV_Workshop_01/mermaid/mermaid.css?1753541793" rel="stylesheet" />
    <script src="/PPV_Workshop_01/mermaid/mermaid.js?1753541793"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-158079754-2', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
